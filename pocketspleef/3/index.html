<!DOCTYPE html>

<html>

<head>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

<style>

* {box-sizing:border-box;user-select: none;touch-action: manipulation;outline:none;font-family:arial;}


body {margin:0px;}

#gamearea {position:fixed;left:0px;top:0px;width:100%;height:100%;}

#game {position:fixed;left:0px;top:0px;width:100%;height:100%;background-color:black;}

#playerButtons1 {position:fixed;left:0px;bottom:0px;height:50%;width:30%;background-color:rgb(50,50,50,0.1);}

#playerButtons2 {position:fixed;right:0px;bottom:0px;height:50%;width:30%;background-color:rgb(50,50,50,0.1);}

.ability {position:absolute;left:0px;top:0px;width:100%;height:50%;background-color:rgb(50,50,50,0.3);border:none;color:white;font-size:50px;}

.left {position:absolute;left:0px;top:50%;width:50%;height:50%;background-color:rgb(50,0,0,0.3);border:none;color:white;font-size:50px;}

.right {position:absolute;right:0px;top:50%;width:50%;height:50%;background-color:rgb(0,0,50,0.3);border:none;color:white;font-size:50px;}

#bot {position:fixed;top:0px;right:0px;width:100px;height:50px;background-color:#FFAAAA;border:none;color:black;font-size:30px;}

#start {position:fixed;left:0px;top:0px;width:100%;height:100%;background-color:black;}

#startbutton {position:fixed;left:50%;width:200px;height:50px;top:50%;margin-left:-100px;margin-top:-25px;color:white;text-align:center;font-family:arial;font-size:40px;background-color:#333333;border-radius:10px;box-shadow:0px 0px 15px red;border:none;}

</style>

<title>Pocket Spleef</title>

</head>

<body>

<div id="gamearea"></div>

<canvas id="game"></canvas>

<div id="playerButtons1">

<button class="ability" ontouchstart="abilityStart1()" ontouchend="abilityEnd1()" onmousedown="abilityStart1()" onmouseup="abilityEnd1()">X</button>
<button class="left" ontouchstart="leftStart1()" ontouchend="leftEnd1()" onmousedown="leftStart1()" onmouseup="leftEnd1()"><</button>
<button class="right" ontouchstart="rightStart1()" ontouchend="rightEnd1()" onmousedown="rightStart1()" onmouseup="rightEnd1()">></button>

</div>

<div id="playerButtons2">

<button class="ability" ontouchstart="abilityStart2()" ontouchend="abilityEnd2()" onmousedown="abilityStart2()" onmouseup="abilityEnd2()">X</button>
<button class="left" ontouchstart="leftStart2()" ontouchend="leftEnd2()" onmousedown="leftStart2()" onmouseup="leftEnd2()"><</button>
<button class="right" ontouchstart="rightStart2()" ontouchend="rightEnd2()" onmousedown="rightStart2()" onmouseup="rightEnd2()">></button>
<button id="bot" onclick="botToggleStart()"><b>BOT</b></button>

</div>

<div id="start">
<button id="startbutton" onclick="setup();document.getElementById('start').remove()">START</button>
</div>

<script>

var game = document.getElementById("game").getContext("2d")
document.getElementById("game").width = document.getElementById("gamearea").offsetWidth
document.getElementById("game").height = document.getElementById("gamearea").offsetHeight
var w = document.getElementById("game").width
var h = document.getElementById("game").height

sessionStorage.ability1 = "false"
sessionStorage.left1 = "false"
sessionStorage.right1 = "false"
sessionStorage.ability2 = "false"
sessionStorage.left2 = "false"
sessionStorage.right2 = "false"
sessionStorage.bot = "false"







document.onkeydown = function (e) {
    e = e || window.event;
    if(e.keyCode == 65) {
		leftStart1()
	}
	else if(e.keyCode == 68) {
		rightStart1()
	}
	else if(e.keyCode == 83) {
		abilityStart1()
	}
	else if(e.keyCode == 37) {
		leftStart2()
	}
	else if(e.keyCode == 39) {
		rightStart2()
	}
	else if(e.keyCode == 40) {
		abilityStart2()
	}
};


document.onkeyup = function (e) {
    e = e || window.event;
    if(e.keyCode == 65) {
		leftEnd1()
	}
	else if(e.keyCode == 68) {
		rightEnd1()
	}
	else if(e.keyCode == 83) {
		abilityEnd1()
	}
	else if(e.keyCode == 37) {
		leftEnd2()
	}
	else if(e.keyCode == 39) {
		rightEnd2()
	}
	else if(e.keyCode == 40) {
		abilityEnd2()
	}
};







function abilityStart1() {
	sessionStorage.ability1 = "true"
}

function abilityEnd1() {
	sessionStorage.ability1 = "false"
}

function leftStart1() {
	sessionStorage.left1 = "true"
}

function leftEnd1() {
	sessionStorage.left1 = "false"
}

function rightStart1() {
	sessionStorage.right1 = "true"
}

function rightEnd1() {
	sessionStorage.right1 = "false"
}



function abilityStart2() {
	sessionStorage.ability2 = "true"
}

function abilityEnd2() {
	sessionStorage.ability2 = "false"
}

function leftStart2() {
	sessionStorage.left2 = "true"
}

function leftEnd2() {
	sessionStorage.left2 = "false"
}

function rightStart2() {
	sessionStorage.right2 = "true"
}

function rightEnd2() {
	sessionStorage.right2 = "false"
}

function botToggleStart() {
	if(sessionStorage.bot == "true") {
		sessionStorage.bot = "false"
		sessionStorage.ability2 = "false"
		sessionStorage.left2 = "false"
		sessionStorage.right2 = "false"
	}
	else {
		sessionStorage.bot = "true"
	}
}





//Images

function loadImage(image) {
	var img = new Image();
	img.addEventListener('load', function() {
	}, false);
	img.src = image;
	return(img)
}

//game.drawImage(image,x,y,w,h)

//Note: Don't make two seperate colors for the same character for each player - but create variations in color for different characters









var maps = ["map1.png","map2.png","map3.png"]
var soundtracks = ["https://docs.google.com/uc?export=open&id=1Nv8QIFOwcKfjgFz5Xrl9tecRNT0NBxjS","https://docs.google.com/uc?export=open&id=1iUQvfiCs4KX3_guID5suCkcsUVquRcq8","https://docs.google.com/uc?export=open&id=1lp0zfDbipoQmXNCcnKAT0hw_xXvIvSR8"]
var soundtracks2 = []
var i = 0
while(i < soundtracks.length) {
	soundtracks2.push(new Audio(soundtracks[i]))
	i += 1
}
//Soundtracks:
//Soundtrack format: https://docs.google.com/uc?export=open&id=[ID]
//cyberchillcompany@gmail.com
//https://drive.google.com/file/d/1Nv8QIFOwcKfjgFz5Xrl9tecRNT0NBxjS/view?usp=sharing 
//https://drive.google.com/file/d/1iUQvfiCs4KX3_guID5suCkcsUVquRcq8/view?usp=sharing 
//https://drive.google.com/file/d/1lp0zfDbipoQmXNCcnKAT0hw_xXvIvSR8/view?usp=sharing

var characters = ["character1"]
var charactersLeft = ["character1left.png"]
var charactersRight = ["character1right.png"]
var soundtrack;

class player {
	constructor(x,y,w,h,vx,vy,jumptimeout,id,direction,characterleft,characterright,health,damageblocks,abilitytimeout,character,hittimeout) {
		this.x = x;
		this.y = y;
		this.vx = vx;
		this.vy = vy;
		this.w = w;
		this.h = h;
		this.jumptimeout = jumptimeout;
		this.id = id;
		this.direction = direction;
		this.characterleft = characterleft;
		this.characterright = characterright;
		this.health = health
		this.damageblocks = damageblocks
		this.abilitytimeout = abilitytimeout
		this.character = character
		this.hittimeout = hittimeout
	}
	move() {
		if(this.abilitytimeout <= 300) {
			this.x += this.vx
			this.y += this.vy
			this.damageblocks = []

			if(this.x >= w - this.w) {
				this.vx = -10
				this.health -= 34
			}

			else if(this.x <= 0) {
				this.vx = 10
				this.health -= 34
			}

			else if(this.y <= 0) {
				this.vy = 10
				this.health -= 34
			}

			else if(this.y >= h - this.h) {
				this.vy = -1*h*0.03
				this.health -= 34
			}
		}
		else {
			this.vx = 0
			this.vy = 0
		}
		if(this.direction == "left") {
			game.drawImage(this.characterleft,this.x,this.y,this.w,this.h)
		}
		else {
			game.drawImage(this.characterright,this.x,this.y,this.w,this.h)
			
		}
		game.font = "15px Arial"
		game.fillStyle = "black"
		game.textAlign = "center"
		game.fillText((this.id).toString(),this.x+this.w/2-1.5,this.y-this.h)

		game.font = "13px Arial"
		game.fillStyle = "white"
		game.textAlign = "center"
		game.fillText((this.id).toString(),this.x+1+this.w/2-0.5,this.y-this.h+1)
		
		
		
		game.fillStyle = "white"
		game.fillRect(0,(this.id-1)*20,this.health*3,10)

		game.fillStyle = "#BBBBBB"
		game.fillRect(0,10+(this.id-1)*20,(450-this.abilitytimeout)*(2/3),10)
		if(this.health <= 0) {
			if(soundtrack) {
				soundtrack.pause()
			}
			clearInterval(gameLoop)
			setup();
		}
	}
	platformCollide(platforms) {
		var i = 0
		var platform;
		while(i < platforms.length) {
			platform = platforms[i]
			if(this.x >= (platform.x - this.w) && this.x <= (platform.x + platform.w) && (this.y + this.h) >= platform.y && this.y <= (platform.y + platform.h)) {
				platform.health -= 1
				if(platform.health <= 0) {
					platform.x = -10000000
				}
				return(true)
			}
			i += 1
		}
		return(false)
	}
	damageBlockCollide() {
		if(this.hittimeout == 0) {
			var i0 = 0
			var i = 0
			var damageblock;
			while(i0 < players.length) {
				if(i0 != this.id-1) {
					i = 0
					while(i < players[i0].damageblocks.length) {
						damageblock = players[i0].damageblocks[i]
						if(this.x >= (damageblock.x - this.w) && this.x <= (damageblock.x + damageblock.w) && (this.y + this.h) >= damageblock.y && this.y <= (damageblock.y + damageblock.h)) {
							players[i0].damageblocks[i].x = -1000000
							this.health -= damageblock.damage
							this.vx = Number(sessionStorage.ran1)
							this.vy = Number(sessionStorage.ran2)
							this.hittimeout = 151
							return(true)
						}
						i += 1
					}
				}
				i0 += 1
			}
			return(false)
		}
		else {
			return(false)
		}
	}
	input() {
		if(this.abilitytimeout <= 300) {
			if(sessionStorage["left"+(this.id).toString()] == "true") {
				if(this.vx > -3) {
					this.vx = truncate(this.vx - 0.3,1)
					this.direction = "left"
				}
			}
			else if(sessionStorage["right"+(this.id).toString()] == "true") {
				if(this.vx < 3) {
					this.vx = truncate(this.vx + 0.3,1)
					this.direction = "right"
				}
			}
			else {
				if(this.vx > 0) {
					this.vx = truncate(this.vx - 0.1,1)
				}
				else if(this.vx < 0) {
					this.vx = truncate(this.vx + 0.1,1)
				}
			}
			if(this.platformCollide(platforms) == false) {
				if(this.vy <= 3) {
					this.vy += 0.3
				}
			}
			else {
				if(this.vy > 0) {
					this.vy = 0
				}
				this.vy -= 0.1
			}
			
			if(this.platformCollide(platforms) == true && this.jumptimeout > 0) {
				if(this.jumpTimeout == 100) {
					this.vy = 0
				}
				if(this.jumptimeout > this.jumptimeout/2) {
					if(this.vy >= -5) {
						this.vy -= 5
					}
					else {
						this.vy = -5
					}
				}
				this.jumptimeout -= 1
			}
			if(this.jumptimeout <= 0) {
				this.jumptimeout = 100
			}
		}
		
		if(sessionStorage["ability"+(this.id).toString()] == "true" && this.abilitytimeout == 0) {
			if(this.direction == "left") {
				this.damageblocks.push(new damageBlock(this.x,this.y,this.w,this.h,50,this.characterleft))
				this.damageblocks[0].draw()
			}
			else {
				this.damageblocks.push(new damageBlock(this.x,this.y,this.w,this.h,50,this.characterright))
				this.damageblocks[0].draw()
			}
			sessionStorage.ran1 = Math.floor(Math.random()*24)-12
			sessionStorage.ran2 = Math.floor(Math.random()*24)-12
			this.abilitytimeout = 450
			sessionStorage["ability"+(this.id).toString()] = "false"
		}
		if(this.abilitytimeout > 0) {
			this.abilitytimeout -= 1
			if(this.abilitytimeout > 300) {
				if(this.character == "character1") {
					if(this.direction == "left") {
						if(this.abilitytimeout > 430) {
							this.damageblocks[0].x = this.x-((450-this.abilitytimeout)*this.w*0.05)
							this.damageblocks[0].y = this.y
							this.damageblocks[0].draw()
						}
						else {
							this.damageblocks[0].x = this.x-this.w
							this.damageblocks[0].y = this.y
							this.damageblocks[0].draw()
						}
					}
					else {
						if(this.abilitytimeout > 430) {
							this.damageblocks[0].x = this.x+((450-this.abilitytimeout)*this.w*0.05)
							this.damageblocks[0].y = this.y
							this.damageblocks[0].draw()
						}
						else {
							this.damageblocks[0].x = this.x+this.w
							this.damageblocks[0].y = this.y
							this.damageblocks[0].draw()
						}
					}
				}
			}
		}
		
		this.damageBlockCollide()
		
		if(this.hittimeout > 0) {
			this.hittimeout -= 1
		}
	}
}

class platform {
	constructor(x,y,w,h,health,type) {
		this.x = x
		this.y = y
		this.w = w
		this.h = h
		this.health = health
		this.type = type
	}
}

class damageBlock {
	constructor(x,y,w,h,damage,image) {
		this.x = x
		this.y = y
		this.w = w
		this.h = h
		this.damage = damage
		this.image = image
	}
	draw() {
		game.drawImage(this.image,this.x,this.y,this.w,this.h)
	}
}

function generatePlatforms() {
	var platforms = []
	var i = 0
	var i2 = 50
	while(i2 < h-100) {
		i = 0
		i2 += 50
		while(i < w - 100) {
			i += Math.floor(Math.random()*100)+25
			platforms.push(new platform(i,i2,15,2.5,20,"normal"))
		}
	}
	return(platforms)
}

function drawPlatforms(platforms) {
	var i = 0
	while(i < platforms.length) {
		//game.fillStyle = "black"
		//game.fillRect(platforms[i].x-1,platforms[i].y-1,platforms[i].w+2,platforms[i].h+2)
		
		//game.fillStyle = "white"
		//game.fillRect(platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		if(platforms[i].health >= 20) {
			game.drawImage(platformStages[0],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		else if(platforms[i].health >= 15) {
			game.drawImage(platformStages[1],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		else if(platforms[i].health >= 10) {
			game.drawImage(platformStages[2],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		else if(platforms[i].health >= 5) {
			game.drawImage(platformStages[3],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		else if(platforms[i].health >= 3) {
			game.drawImage(platformStages[4],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		else if(platforms[i].health >= 1) {
			game.drawImage(platformStages[4],platforms[i].x,platforms[i].y,platforms[i].w,platforms[i].h)
		}
		i += 1
	}
}

function bot(players) {
	if(sessionStorage.bot == "true") {
		var player1 = players[0]
		var player2 = players[1]
		if(player1.x < player2.x) {
			sessionStorage.right2 = "false"
			sessionStorage.left2 = "true"
		}
		else {
			sessionStorage.left2 = "false"
			sessionStorage.right2 = "true"
		}
		
		sessionStorage.ability2 = "true"
		document.getElementById("bot").style.backgroundColor = "#AAFFAA"
	}
	else {
		document.getElementById("bot").style.backgroundColor = "#FFAAAA"
	}
}

var platformStages = [loadImage("platform1.png"),loadImage("platform2.png"),loadImage("platform3.png"),loadImage("platform4.png"),loadImage("platform5.png"),loadImage("platform6.png")]

var platforms;

var randomMap;

var randomCharacter1;
var player1;

var randomCharacter2;
var player2;

var players;

var randomMap0 = ""

function setup() {

	sessionStorage.ability1 = "false"
	sessionStorage.left1 = "false"
	sessionStorage.right1 = "false"
	sessionStorage.ability2 = "false"
	sessionStorage.left2 = "false"
	sessionStorage.right2 = "false"

	platforms = generatePlatforms()

	randomMap0 = maps[Math.floor(Math.random()*maps.length)]
	randomMap = loadImage(randomMap0)


	
	
	soundtrack = soundtracks2[maps.indexOf(randomMap0)]

	soundtrack.volume = "0.5"
	soundtrack.loop = true
	soundtrack.currentTime = 0
	soundtrack.play()
	

	randomCharacter1 = Math.floor(Math.random()*charactersLeft.length)
	player1 = new player(150,50,15,15,0,0,100,1,"right",loadImage(charactersLeft[randomCharacter1]),loadImage(charactersRight[randomCharacter1]),100,[],0,characters[randomCharacter1],0)

	randomCharacter2 = Math.floor(Math.random()*charactersLeft.length)
	player2 = new player(w-180,50,15,15,0,0,100,2,"left",loadImage(charactersLeft[randomCharacter2]),loadImage(charactersRight[randomCharacter2]),100,[],0,characters[randomCharacter2],0)

	players = [player1,player2]

	gameLoop = setInterval(gameLoop1,10)

}



function truncate(n,m) {
	if(n >= 0) {
		return(Math.floor(n*10**m)/(10**m))
	}
	else {
		n = n * -1
		return((Math.floor(n*10**m)/(10**m))*-1)
	}
}

function gameLoop1() {
	if(soundtrack.paused) {
		soundtrack.play()
	}
	game.drawImage(randomMap,0,0,w,h)
	drawPlatforms(platforms)
	var i = 0
	while(i < players.length) {
		players[i].input()
		players[i].move()
		i += 1
	}
	bot(players)
}

</script>

</body>

</html>